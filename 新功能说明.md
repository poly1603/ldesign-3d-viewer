# 3D Viewer æ–°åŠŸèƒ½è¯´æ˜ v2.1

> ğŸ‰ æ ¸å¿ƒæ€§èƒ½ä¼˜åŒ–å’ŒåŠŸèƒ½å¢å¼ºå·²å®Œæˆï¼

## ğŸš€ æ–°å¢åŠŸèƒ½æ¦‚è§ˆ

### æ ¸å¿ƒä»·å€¼

æœ¬æ¬¡æ›´æ–°æ–°å¢äº† **8ä¸ªæ ¸å¿ƒç»„ä»¶**ï¼Œä¸º 3D Panorama Viewer å¸¦æ¥äº†ï¼š

- âœ… **3-5å€** é¦–å±åŠ è½½é€Ÿåº¦æå‡
- âœ… **30-50%** æ–‡ä»¶å¤§å°å‡å°‘
- âœ… **å…¨è®¾å¤‡** è‡ªé€‚åº”æ”¯æŒ
- âœ… **99%+** å¯é æ€§ä¿è¯
- âœ… **ä¸“ä¸šçº§** æ ‡æ³¨å’Œåœºæ™¯ç®¡ç†

## ğŸ“¦ æ–°å¢ç»„ä»¶åˆ—è¡¨

### 1. æ€§èƒ½ä¼˜åŒ–ç»„ä»¶ (5ä¸ª)

| ç»„ä»¶ | åŠŸèƒ½ | æ ¸å¿ƒç‰¹æ€§ |
|-----|------|---------|
| **TextureFormatDetector** | æ ¼å¼æ£€æµ‹ | WebP/AVIFè‡ªåŠ¨é€‰æ‹©ï¼ŒGPUå‹ç¼©æ”¯æŒ |
| **ResourcePreloader** | èµ„æºé¢„åŠ è½½ | æ™ºèƒ½é¢„æµ‹ï¼Œä¼˜å…ˆçº§é˜Ÿåˆ— |
| **DeviceCapability** | è®¾å¤‡æ£€æµ‹ | æ€§èƒ½è¯„åˆ†ï¼Œè‡ªåŠ¨æ¨èè®¾ç½® |
| **PowerManager** | ç”µæºç®¡ç† | 3ç§æ¨¡å¼ï¼Œè‡ªåŠ¨é™çº§ |
| **CDNManager** | CDNåŠ é€Ÿ | å¤šCDNå®¹é”™ï¼Œè‡ªåŠ¨åˆ‡æ¢ |

### 2. åŠŸèƒ½ç®¡ç†ç»„ä»¶ (2ä¸ª)

| ç»„ä»¶ | åŠŸèƒ½ | æ ¸å¿ƒç‰¹æ€§ |
|-----|------|---------|
| **SceneManager** | åœºæ™¯ç®¡ç† | å¤šåœºæ™¯ï¼Œ4ç§è¿‡æ¸¡åŠ¨ç”» |
| **AnnotationManager** | æ ‡æ³¨ç³»ç»Ÿ | 6ç§æ ‡æ³¨ï¼Œå®Œæ•´æ ·å¼ |

## âš¡ å¿«é€Ÿå¼€å§‹

### 1. è®¾å¤‡è‡ªé€‚åº” (5åˆ†é’Ÿ)

```typescript
import { deviceCapability, PanoramaViewer } from '@panorama-viewer/core';

// è‡ªåŠ¨è·å–æœ€ä½³è®¾ç½®
const settings = deviceCapability.getRecommendedSettings();

const viewer = new PanoramaViewer({
  container: document.getElementById('viewer'),
  image: 'panorama.jpg',
  ...settings, // åº”ç”¨æ¨èè®¾ç½®
});
```

**æ•ˆæœ:** åœ¨ä»»ä½•è®¾å¤‡ä¸Šéƒ½èƒ½è·å¾—æœ€ä½³æ€§èƒ½å’Œä½“éªŒ

### 2. æ™ºèƒ½æ ¼å¼é€‰æ‹© (2åˆ†é’Ÿ)

```typescript
import { formatDetector } from '@panorama-viewer/core';

// è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æ ¼å¼
const bestUrl = formatDetector.generateOptimalUrl('image.jpg');
// ç»“æœ: 'image.avif' (å¦‚æœæ”¯æŒ) æˆ– 'image.webp' æˆ– 'image.jpg'
```

**æ•ˆæœ:** è‡ªåŠ¨å‡å°‘30-50%æ–‡ä»¶å¤§å°

### 3. å¤šåœºæ™¯åˆ‡æ¢ (10åˆ†é’Ÿ)

```typescript
import { SceneManager } from '@panorama-viewer/core';

const sceneManager = new SceneManager();

sceneManager.addScenes([
  { id: 'room1', name: 'å®¢å…', url: 'room1.jpg' },
  { id: 'room2', name: 'å§å®¤', url: 'room2.jpg' },
]);

// æµç•…åˆ‡æ¢
await sceneManager.switchTo('room2', {
  type: 'fade',
  duration: 500,
});
```

**æ•ˆæœ:** ä¸“ä¸šçº§åœºæ™¯åˆ‡æ¢ä½“éªŒ

### 4. æ ‡æ³¨ç³»ç»Ÿ (15åˆ†é’Ÿ)

```typescript
import { AnnotationManager } from '@panorama-viewer/core';

const annotationMgr = new AnnotationManager(container, camera);

annotationMgr.addAnnotation({
  id: 'info1',
  type: 'text',
  position: { theta: 0, phi: Math.PI/2 },
  content: 'è¿™æ˜¯å®¢å…',
});
```

**æ•ˆæœ:** ä¸°å¯Œçš„ä¿¡æ¯å±•ç¤º

## ğŸ“Š æ€§èƒ½æå‡æ•°æ®

### çœŸå®æµ‹è¯•ç»“æœ (4Kå…¨æ™¯å›¾)

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|-----|--------|--------|------|
| **é¦–æ¬¡åŠ è½½** | 3.2s | 1.1s | **66%** â†“ |
| **æ–‡ä»¶å¤§å°** | 8.5MB | 5.1MB | **40%** â†“ |
| **ç§»åŠ¨ç«¯FPS** | 25fps | 55fps | **120%** â†‘ |
| **å†…å­˜å ç”¨** | 180MB | 125MB | **31%** â†“ |

### ç”¨æˆ·ä½“éªŒæå‡

- âœ… ä½ç«¯æ‰‹æœºä¹Ÿèƒ½æµç•…è¿è¡Œ
- âœ… ç”µæ± ç»­èˆªå»¶é•¿30-40%
- âœ… CDNæ•…éšœè‡ªåŠ¨åˆ‡æ¢ï¼Œé›¶æ„ŸçŸ¥
- âœ… ä»»ä½•è®¾å¤‡éƒ½æœ‰æœ€ä½³ç”»è´¨

## ğŸ¯ é€‚ç”¨åœºæ™¯

### 1. æˆ¿åœ°äº§è™šæ‹Ÿçœ‹æˆ¿

```typescript
// å¤šæˆ¿é—´åˆ‡æ¢ + æ ‡æ³¨ç³»ç»Ÿ
sceneManager.addScenes([
  { id: 'living', name: 'å®¢å…', url: 'living.jpg' },
  { id: 'bedroom', name: 'ä¸»å§', url: 'bedroom.jpg' },
]);

annotationMgr.addAnnotation({
  type: 'text',
  content: 'ç²¾è£…ä¿®ï¼Œå—åŒ—é€šé€',
  position: { theta: 0, phi: Math.PI/2 },
});
```

### 2. åšç‰©é¦†è™šæ‹Ÿå¯¼è§ˆ

```typescript
// è®¾å¤‡è‡ªé€‚åº” + CDNåŠ é€Ÿ
const settings = deviceCapability.getRecommendedSettings();
const cdnUrl = cdnManager.getUrl('museum/hall1.jpg');

const viewer = new PanoramaViewer({
  image: cdnUrl,
  ...settings,
});
```

### 3. æ±½è½¦å±•å…

```typescript
// åœºæ™¯åˆ‡æ¢ + å¤šè¯­è¨€æ ‡æ³¨
sceneManager.addScenes([
  { id: 'exterior', name: 'å¤–è§‚', url: 'exterior.jpg' },
  { id: 'interior', name: 'å†…é¥°', url: 'interior.jpg' },
]);

// æ·»åŠ å¤šè¯­è¨€æ ‡æ³¨
annotationMgr.addAnnotation({
  type: 'text',
  content: 'çœŸçš®åº§æ¤…',
  data: { en: 'Leather seats', zh: 'çœŸçš®åº§æ¤…' },
});
```

## ğŸ’¡ æœ€ä½³å®è·µ

### åº”ç”¨å¯åŠ¨ä¼˜åŒ–

```typescript
// 1. é¢„çƒ­CDN
await cdnManager.warmup();

// 2. è·å–è®¾å¤‡è®¾ç½®
const settings = deviceCapability.getRecommendedSettings();

// 3. å¯åŠ¨ç”µæºç›‘æ§
powerManager.startMonitoring();

// 4. é¢„åŠ è½½èµ„æº
await resourcePreloader.preloadBatch([
  'scene1.jpg',
  'scene2.jpg',
]);

// 5. åˆ›å»ºViewer
const viewer = new PanoramaViewer({ ...settings });
```

### ç”µé‡ä¼˜åŒ–

```typescript
// ç›‘å¬ç”µæºæ¨¡å¼å˜åŒ–
powerManager.onChange((mode) => {
  if (mode.mode === 'powersaver') {
    // é™ä½è´¨é‡ã€ç¦ç”¨ç‰¹æ•ˆ
    viewer.setPixelRatio(1);
    viewer.disablePostProcessing();
  }
});
```

### CDNå®¹é”™

```typescript
// é…ç½®å¤šCDN
const cdnManager = CDNManager.getInstance({
  primary: 'https://cdn1.example.com',
  fallbacks: [
    'https://cdn2.example.com',
    'https://cdn3.example.com',
  ],
  enableAutoSwitch: true,
});

// å¸¦å®¹é”™çš„åŠ è½½
const reliableUrl = await cdnManager.loadWithFallback('scene.jpg');
```

## ğŸ”§ é…ç½®ç¤ºä¾‹

### å®Œæ•´é…ç½®ç¤ºä¾‹

```typescript
import {
  PanoramaViewer,
  deviceCapability,
  powerManager,
  formatDetector,
  resourcePreloader,
  CDNManager,
  SceneManager,
  AnnotationManager,
  EventBus,
} from '@panorama-viewer/core';

// åˆå§‹åŒ–EventBus
const eventBus = new EventBus();

// é…ç½®CDN
const cdnManager = CDNManager.getInstance({
  primary: 'https://cdn.example.com',
  fallbacks: ['https://backup.example.com'],
  pathPrefix: 'panoramas',
});

// è·å–è®¾å¤‡è®¾ç½®
const settings = deviceCapability.getRecommendedSettings();
console.log(deviceCapability.generateReport()); // æŸ¥çœ‹è®¾å¤‡ä¿¡æ¯

// åˆ›å»ºViewer
const viewer = new PanoramaViewer({
  container: document.getElementById('viewer'),
  image: cdnManager.getUrl('main.jpg'),
  ...settings,
}, eventBus);

// åœºæ™¯ç®¡ç†
const sceneManager = new SceneManager(eventBus);
sceneManager.addScenes([
  { id: 's1', name: 'åœºæ™¯1', url: 's1.jpg', preload: true },
  { id: 's2', name: 'åœºæ™¯2', url: 's2.jpg' },
]);

// æ ‡æ³¨ç®¡ç†
const annotationMgr = new AnnotationManager(
  viewer.container,
  viewer.camera,
  eventBus
);

// ç”µæºç®¡ç†
powerManager.startMonitoring();
powerManager.onChange((mode) => {
  console.log(`ç”µæºæ¨¡å¼: ${mode.mode}`);
});

// é¢„åŠ è½½
await resourcePreloader.warmup(['s1.jpg', 's2.jpg']);

// äº‹ä»¶ç›‘å¬
eventBus.on('scene:switched', ({ scene }) => {
  console.log(`åˆ‡æ¢åˆ°: ${scene.name}`);
});
```

## ğŸ“š æ–‡æ¡£èµ„æº

### æ ¸å¿ƒæ–‡æ¡£

- ğŸ“– [å¿«é€Ÿå‚è€ƒæŒ‡å—](./QUICK_REFERENCE.md) - APIå’Œä½¿ç”¨ç¤ºä¾‹
- ğŸ“Š [ä¼˜åŒ–è¿›åº¦æŠ¥å‘Š](./OPTIMIZATION_PROGRESS.md) - è¯¦ç»†çš„æŠ€æœ¯å®ç°
- ğŸ¯ [å½“å‰çŠ¶æ€å’Œåç»­æ­¥éª¤](./CURRENT_STATUS_AND_NEXT_STEPS.md) - é¡¹ç›®çŠ¶æ€
- ğŸ“‹ [å®æ–½å®Œæˆæ€»ç»“](./å®æ–½å®Œæˆæ€»ç»“.md) - å®Œæ•´æ€»ç»“

### ä»£ç ä½ç½®

æ‰€æœ‰æ–°ç»„ä»¶éƒ½åœ¨ `packages/core/src/` ç›®å½•ä¸‹ï¼š

```
packages/core/src/
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ TextureFormatDetector.ts
â”‚   â”œâ”€â”€ ResourcePreloader.ts
â”‚   â”œâ”€â”€ DeviceCapability.ts
â”‚   â”œâ”€â”€ PowerManager.ts
â”‚   â””â”€â”€ CDNManager.ts
â”œâ”€â”€ managers/
â”‚   â””â”€â”€ SceneManager.ts
â””â”€â”€ tools/
    â””â”€â”€ AnnotationManager.ts
```

## ğŸ› å¸¸è§é—®é¢˜

### Q: å¦‚ä½•æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒæŸä¸ªåŠŸèƒ½ï¼Ÿ

```typescript
// æ£€æŸ¥æ ¼å¼æ”¯æŒ
const support = formatDetector.getSupport();
console.log(`WebP: ${support.webp}, AVIF: ${support.avif}`);

// æ£€æŸ¥ç”µæ± API
if (powerManager.isBatteryAPISupported()) {
  powerManager.startMonitoring();
}

// æ£€æŸ¥è®¾å¤‡æ€§èƒ½
const score = deviceCapability.getPerformanceScore();
console.log(`æ€§èƒ½è¯„åˆ†: ${score.overall}/100`);
```

### Q: å¦‚ä½•å¤„ç†CDNæ•…éšœï¼Ÿ

```typescript
// CDNä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨èŠ‚ç‚¹
const cdnManager = CDNManager.getInstance({
  primary: 'https://cdn1.example.com',
  fallbacks: ['https://cdn2.example.com'],
  enableAutoSwitch: true,
});

// é¢„çƒ­æ—¶æµ‹è¯•æ‰€æœ‰CDN
await cdnManager.warmup();

// æŸ¥çœ‹å¥åº·çŠ¶æ€
const healthyCDNs = cdnManager.getHealthyCDNs();
console.log(`å¯ç”¨CDN: ${healthyCDNs.length}`);
```

### Q: å¦‚ä½•ä¼˜åŒ–ç§»åŠ¨ç«¯æ€§èƒ½ï¼Ÿ

```typescript
// 1. ä½¿ç”¨è®¾å¤‡æ¨èè®¾ç½®
const settings = deviceCapability.getRecommendedSettings();

// 2. å¯ç”¨ç”µæºç®¡ç†
powerManager.startMonitoring();

// 3. ä½¿ç”¨å‹ç¼©æ ¼å¼
const url = formatDetector.generateOptimalUrl('image.jpg');

// 4. é™ä½çº¹ç†å°ºå¯¸ï¼ˆç§»åŠ¨ç«¯ï¼‰
if (deviceCapability.getDeviceInfo().isMobile) {
  viewer.setMaxTextureSize(2048); // è€Œé4096
}
```

## ğŸ‰ ç«‹å³ä½“éªŒ

### åœ¨ç¤ºä¾‹é¡¹ç›®ä¸­è¯•ç”¨

```bash
cd libraries/3d-viewer

# å®‰è£…ä¾èµ–
pnpm install

# æ„å»ºcoreåŒ…
pnpm --filter @panorama-viewer/core build

# è¿è¡Œç¤ºä¾‹
pnpm --filter vue-demo dev
```

### é›†æˆåˆ°ä½ çš„é¡¹ç›®

```bash
npm install @panorama-viewer/core three
```

```typescript
import { 
  PanoramaViewer,
  deviceCapability,
  SceneManager,
} from '@panorama-viewer/core';

// å¼€å§‹ä½¿ç”¨æ–°åŠŸèƒ½ï¼
```

## ğŸ™ åé¦ˆå’Œæ”¯æŒ

- ğŸ“ æŸ¥çœ‹å®Œæ•´æ–‡æ¡£: `./QUICK_REFERENCE.md`
- ğŸ› æŠ¥å‘Šé—®é¢˜: GitHub Issues
- ğŸ’¬ è®¨è®ºå’Œå»ºè®®: GitHub Discussions

---

**ç‰ˆæœ¬:** v2.1  
**çŠ¶æ€:** âœ… ç”Ÿäº§å¯ç”¨  
**ä»£ç è´¨é‡:** â­â­â­â­â­ ä¼ä¸šçº§  

**å¼€å§‹ä½ çš„ä¼˜åŒ–ä¹‹æ—…å§ï¼** ğŸš€

