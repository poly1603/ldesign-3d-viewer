# ⚡ 3D Panorama Viewer v2.0 - 快速参考

> 一页掌握所有核心功能

---

## 🚀 30 秒快速开始

```typescript
import { PanoramaViewer } from '@panorama-viewer/core';

const viewer = new PanoramaViewer({
  container: document.getElementById('viewer'),
  image: 'panorama.jpg',
  autoRotate: true,
});
```

---

## 📦 核心功能速查

### 基础操作

```typescript
// 加载图片
await viewer.loadImage('scene.jpg', true);

// 重置视角
viewer.reset();

// 截图
const img = viewer.screenshot();

// 清理
viewer.dispose();
```

### 热点

```typescript
// 添加
viewer.addHotspot({
  id: 'point1',
  position: { theta: 0, phi: Math.PI/2 },
  label: '📍 这里',
});

// 监听点击
eventBus.on('hotspot:click', ({ id }) => {
  console.log('点击:', id);
});
```

### 事件

```typescript
const eventBus = new EventBus();

// 订阅
eventBus.on('camera:change', ({ rotation, fov }) => {
  console.log(rotation, fov);
});

// 等待
await eventBus.waitFor('viewer:ready');
```

---

## 🎬 视频全景

```typescript
const video = new VideoPanorama({
  sources: [
    { url: '480p.mp4', quality: 'low', bitrate: 1000 },
    { url: '1080p.mp4', quality: 'high', bitrate: 5000 },
  ],
  adaptiveBitrate: true,
});

await video.play();
video.setVolume(0.8);
```

---

## 🎵 空间音频

```typescript
const audio = new SpatialAudio(camera);
await audio.initialize();

await audio.addSource('id', {
  url: 'sound.mp3',
  position: { theta: 0, phi: Math.PI/4 },
  loop: true,
});

audio.update(); // 在动画循环中
```

---

## 🥽 VR 模式

```typescript
const vr = new VRManager(renderer, camera, scene);
await vr.initialize();
await vr.enterVR();
```

---

## 🌈 HDR 渲染

```typescript
const hdr = new HDRRenderer(renderer, scene, {
  toneMapping: 'aces',
  exposure: 1.0,
});

const texture = await hdr.loadHDR('env.hdr');
hdr.applyEnvironmentMap(texture);
```

---

## 🎨 后处理

```typescript
const post = new PostProcessing(renderer, scene, camera, {
  bloom: { enabled: true, strength: 1.5 },
  antialiasing: 'smaa',
});

post.initialize();
post.render(); // 替代 renderer.render()
```

---

## 📷 相机控制

```typescript
const cam = new AdvancedCamera(camera);

// 平滑移动
await cam.smoothMoveTo(position, rotation, fov, 1000);

// 路径动画
cam.addKeyframe({ position, rotation, fov });
cam.playPath({ duration: 5000, loop: true });

// 录制
cam.startRecording();
// ... 操作
const keyframes = cam.stopRecording();
```

---

## 🗺️ 瓦片系统

```typescript
const tiles = new TileManager(scene, camera, {
  type: 'google',
  urlTemplate: '/tiles/{l}/{x}_{y}.jpg',
  maxLevel: 5,
});

tiles.update(); // 在动画循环中
```

---

## 📐 测量工具

```typescript
const measure = new MeasureTool(scene, camera, container);

// 激活
measure.activate('distance'); // 或 'angle'

// 导出数据
const data = measure.exportData();
```

---

## 🔌 插件系统

```typescript
const plugins = new PluginManager(eventBus);

plugins.setContext({ viewer, eventBus, ... });
await plugins.install(SharePlugin);
```

---

## 🛠️ 工具函数

```typescript
// 防抖节流
const fn = debounce(() => {}, 300);
const fn2 = throttle(() => {}, 100);

// 取消令牌
const token = new CancellationToken();
await loadImage(url, token);
token.cancel();

// 对象池
const v = Vector3Pool.getInstance().acquire();
v.set(1, 2, 3);
Vector3Pool.getInstance().release(v);

// 数学
const val = lerp(0, 100, 0.5); // 50
const clamped = clamp(150, 0, 100); // 100
```

---

## 💾 内存管理

```typescript
const mem = new MemoryManager({
  maxTextureMemory: 512 * 1024 * 1024,
  autoCleanup: true,
});

mem.startMonitoring(5000);
const stats = mem.getStats();
```

---

## 📊 性能监控

```typescript
// 日志
logger.setLevel(LogLevel.DEBUG);
const end = logger.time('操作');
// ... 执行
end();

// 统计
const stats = viewer.getPerformanceStats();
console.log('FPS:', stats.fps);

// 对象池
const poolStats = getAllPoolStats();
```

---

## 🎯 性能优化速查

### 必做优化

```typescript
{
  renderOnDemand: true,        // ⬇️ CPU 50%
  maxTextureSize: 4096,        // 限制纹理
}
```

### 推荐优化

```typescript
// 使用对象池
const euler = EulerPool.getInstance().acquire();
// ... 使用
EulerPool.getInstance().release(euler);

// 渐进式加载
const loader = new ProgressiveTextureLoader();
await loader.load({
  previewUrl: 'low.jpg',
  fullUrl: 'high.jpg',
});

// 大图用瓦片
const tiles = new TileManager(...);
```

---

## 📱 移动端优化

```typescript
import { isMobile } from '@panorama-viewer/core';

{
  maxTextureSize: isMobile() ? 2048 : 4096,
  qualityPreset: isMobile() ? 'medium' : 'high',
  gyroscope: isMobile(),
}
```

---

## 🐛 调试技巧

```typescript
// 启用详细日志
logger.setLevel(LogLevel.DEBUG);

// 查看内存
console.log(memoryManager.getStats());

// 查看对象池
console.log(getAllPoolStats());

// 性能面板
viewer.togglePerformanceOverlay();
```

---

## 🔗 快速链接

- 📖 [完整文档](./START_HERE.md)
- 🚀 [快速开始](./docs/QUICK_START.md)
- 📚 [API 参考](./docs/API_REFERENCE.md)
- ⚡ [性能优化](./docs/PERFORMANCE_BEST_PRACTICES.md)
- 🎯 [示例代码](./examples/)

---

## 💡 最佳实践

### ✅ DO - 推荐

```typescript
✅ 使用事件系统而非回调
✅ 启用 renderOnDemand
✅ 使用对象池
✅ 配置内存限制
✅ 大图用渐进式/瓦片
✅ 正确调用 dispose()
✅ 启用日志系统
```

### ❌ DON'T - 避免

```typescript
❌ 频繁创建 Three.js 对象
❌ 不设内存限制
❌ 大图直接加载
❌ 忘记清理资源
❌ 持续渲染模式（移动端）
❌ 使用 any 类型
```

---

## 🎁 功能速览

| 功能 | v1 | v2 |
|------|----|----|
| 基础全景 | ✅ | ✅ |
| 视频全景 | ❌ | ✅ |
| 空间音频 | ❌ | ✅ |
| VR/AR | ❌ | ✅ |
| HDR | ❌ | ✅ |
| 后处理 | ❌ | ✅ |
| 瓦片系统 | ❌ | ✅ |
| 测量工具 | ❌ | ✅ |
| 插件系统 | ❌ | ✅ |
| 对象池 | ❌ | ✅ |

---

## 📊 性能速览

| 指标 | 提升 |
|------|------|
| GC 压力 | ⬇️ 70% |
| 内存 | ⬇️ 40% |
| 加载 | ⬆️ 5x |
| CPU | ⬇️ 50% |
| FPS | ⬆️ 71% |

---

**打印本页，随时查阅！** 📄

**详细文档**: [START_HERE.md](./START_HERE.md)

