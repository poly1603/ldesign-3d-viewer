<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3D Panorama Viewer - 高级示例</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
    }

    #viewer {
      width: 100vw;
      height: 100vh;
    }

    .controls-panel {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 20px;
      border-radius: 8px;
      min-width: 250px;
      max-height: 80vh;
      overflow-y: auto;
      z-index: 1000;
    }

    .controls-panel h3 {
      margin: 0 0 15px 0;
      font-size: 18px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 10px;
    }

    .control-group {
      margin-bottom: 20px;
    }

    .control-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 12px;
      color: #aaa;
    }

    .control-group button {
      width: 100%;
      padding: 10px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .control-group button:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .control-group button.active {
      background: rgba(76, 175, 80, 0.5);
      border-color: #4CAF50;
    }

    .control-group input[type="range"] {
      width: 100%;
      margin-top: 5px;
    }

    .stats-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: #0f0;
      padding: 15px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      z-index: 1000;
      min-width: 200px;
    }

    .stats-panel .stat-row {
      margin-bottom: 5px;
    }

    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .loading-overlay.hidden {
      display: none;
    }

    .progress-bar {
      width: 300px;
      height: 6px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 20px;
    }

    .progress-bar-fill {
      height: 100%;
      background: #4CAF50;
      transition: width 0.3s;
      width: 0%;
    }

    .loading-text {
      color: white;
      font-size: 18px;
    }
  </style>
</head>

<body>
  <div id="viewer"></div>

  <!-- 加载界面 -->
  <div id="loading" class="loading-overlay">
    <div class="loading-text">加载中...</div>
    <div class="progress-bar">
      <div id="progress-fill" class="progress-bar-fill"></div>
    </div>
    <div id="progress-text" style="color: white; margin-top: 10px;">0%</div>
  </div>

  <!-- 控制面板 -->
  <div class="controls-panel">
    <h3>🎮 控制面板</h3>

    <div class="control-group">
      <label>场景切换</label>
      <button onclick="loadScene('living-room')">客厅</button>
      <button onclick="loadScene('kitchen')">厨房</button>
      <button onclick="loadScene('bedroom')">卧室</button>
    </div>

    <div class="control-group">
      <label>相机控制</label>
      <button onclick="resetCamera()">重置视角</button>
      <button onclick="toggleAutoRotate()">自动旋转</button>
      <button onclick="startTour()">自动导览</button>
      <button onclick="stopTour()">停止导览</button>
    </div>

    <div class="control-group">
      <label>测量工具</label>
      <button id="measure-distance-btn" onclick="activateMeasure('distance')">测距</button>
      <button id="measure-angle-btn" onclick="activateMeasure('angle')">测角</button>
      <button onclick="clearMeasurements()">清除测量</button>
    </div>

    <div class="control-group">
      <label>后处理效果</label>
      <button onclick="toggleBloom()">Bloom 光晕</button>
      <button onclick="toggleVignette()">晕影效果</button>
      <label>曝光: <span id="exposure-value">1.0</span></label>
      <input type="range" min="0" max="3" step="0.1" value="1.0" oninput="setExposure(this.value)">
    </div>

    <div class="control-group">
      <label>音频</label>
      <button onclick="toggleAudio()">开启/关闭音频</button>
      <label>音量: <span id="volume-value">80%</span></label>
      <input type="range" min="0" max="1" step="0.1" value="0.8" oninput="setVolume(this.value)">
    </div>

    <div class="control-group">
      <label>VR/截图</label>
      <button id="vr-btn" onclick="enterVR()">进入 VR</button>
      <button onclick="takeScreenshot()">截图</button>
      <button onclick="toggleFullscreen()">全屏</button>
    </div>
  </div>

  <!-- 统计面板 -->
  <div class="stats-panel">
    <div class="stat-row">FPS: <span id="fps">--</span></div>
    <div class="stat-row">帧时间: <span id="frametime">--</span>ms</div>
    <div class="stat-row">内存: <span id="memory">--</span>MB</div>
    <div class="stat-row">纹理: <span id="textures">--</span></div>
    <div class="stat-row">瓦片: <span id="tiles">--</span></div>
  </div>

  <script type="module">
    import {
      PanoramaViewer,
      EventBus,
      MemoryManager,
      PostProcessing,
      AdvancedCamera,
      SpatialAudio,
      VRManager,
      MeasureTool,
      TileManager,
      PluginManager,
      SharePlugin,
      HDRRenderer,
      logger,
      LogLevel,
      isMobile,
    } from '@panorama-viewer/core';

    // 设置日志
    logger.setLevel(LogLevel.INFO);

    // 创建事件总线
    const eventBus = new EventBus();

    // 全局变量
    let viewer, memoryManager, postProcessing, advancedCamera;
    let spatialAudio, vrManager, measureTool, tileManager;
    let hdrRenderer, pluginManager;

    // 初始化
    async function init() {
      const container = document.getElementById('viewer');

      // 创建 viewer
      viewer = new PanoramaViewer({
        container,
        image: 'panorama.jpg',
        autoRotate: true,
        autoRotateSpeed: 0.3,
        renderOnDemand: true,
        enablePerformanceMonitor: true,
        enableAdaptiveQuality: true,
        maxTextureSize: isMobile() ? 2048 : 4096,
      }, eventBus);

      // 内存管理
      memoryManager = new MemoryManager({
        maxTextureMemory: 512 * 1024 * 1024,
        autoCleanup: true,
      }, eventBus);
      memoryManager.startMonitoring(5000);

      // 后处理
      postProcessing = new PostProcessing(
        viewer.renderer,
        viewer.scene,
        viewer.camera,
        {
          antialiasing: 'smaa',
          bloom: { enabled: true, strength: 1.5 },
          vignette: { enabled: true },
        }
      );
      postProcessing.initialize();

      // HDR 渲染器
      hdrRenderer = new HDRRenderer(viewer.renderer, viewer.scene, {
        toneMapping: 'aces',
        exposure: 1.0,
      });

      // 高级相机
      advancedCamera = new AdvancedCamera(viewer.camera);

      // 空间音频
      spatialAudio = new SpatialAudio(viewer.camera);

      // VR 管理器
      vrManager = new VRManager(
        viewer.renderer,
        viewer.camera,
        viewer.scene,
        { controllers: true },
        eventBus
      );

      // 检查 VR 支持
      const vrSupported = await VRManager.isVRSupported();
      if (!vrSupported) {
        document.getElementById('vr-btn').disabled = true;
        document.getElementById('vr-btn').textContent = 'VR 不支持';
      }

      // 测量工具
      measureTool = new MeasureTool(
        viewer.scene,
        viewer.camera,
        container,
        eventBus
      );

      // 插件管理器
      pluginManager = new PluginManager(eventBus);
      pluginManager.setContext({
        viewer,
        eventBus,
        scene: viewer.scene,
        camera: viewer.camera,
        renderer: viewer.renderer,
        container,
      });
      await pluginManager.install(SharePlugin);

      // 监听事件
      setupEventListeners();

      // 隐藏加载界面
      document.getElementById('loading').classList.add('hidden');

      // 开始动画循环
      animate();
    }

    // 事件监听
    function setupEventListeners() {
      eventBus.on('image:loading', ({ progress }) => {
        updateProgress(progress);
      });

      eventBus.on('viewer:ready', () => {
        console.log('Viewer ready!');
      });

      eventBus.on('performance:warning', ({ type, message }) => {
        console.warn('Performance warning:', message);
      });

      eventBus.on('hotspot:click', ({ id }) => {
        console.log('Hotspot clicked:', id);
      });
    }

    // 更新进度
    function updateProgress(progress) {
      const fill = document.getElementById('progress-fill');
      const text = document.getElementById('progress-text');
      fill.style.width = progress + '%';
      text.textContent = progress.toFixed(1) + '%';
    }

    // 动画循环
    function animate() {
      advancedCamera.update();
      if (spatialAudio) spatialAudio.update();
      if (measureTool) measureTool.update();
      if (tileManager) tileManager.update();
      if (pluginManager) pluginManager.update(16);

      postProcessing.render();

      // 更新统计
      updateStats();

      requestAnimationFrame(animate);
    }

    // 更新统计面板
    function updateStats() {
      const stats = viewer.getPerformanceStats();
      if (stats) {
        document.getElementById('fps').textContent = stats.fps;
        document.getElementById('frametime').textContent = stats.frameTime.toFixed(2);
      }

      const memStats = memoryManager.getStats();
      const memMB = (memStats.total / 1024 / 1024).toFixed(1);
      document.getElementById('memory').textContent = memMB;
      document.getElementById('textures').textContent = memStats.textures.count;

      if (tileManager) {
        const tileStats = tileManager.getStats();
        document.getElementById('tiles').textContent =
          `${tileStats.visibleTiles}/${tileStats.loadedTiles}`;
      }
    }

    // 全局函数
    window.loadScene = async function (scene) {
      const sceneUrls = {
        'living-room': 'living-room.jpg',
        'kitchen': 'kitchen.jpg',
        'bedroom': 'bedroom.jpg',
      };

      await viewer.loadImage(sceneUrls[scene], true);
    };

    window.resetCamera = function () {
      viewer.reset();
    };

    window.toggleAutoRotate = function () {
      if (viewer.isAutoRotating()) {
        viewer.disableAutoRotate();
      } else {
        viewer.enableAutoRotate();
      }
    };

    window.startTour = function () {
      // 添加关键帧
      advancedCamera.clearKeyframes();
      advancedCamera.addKeyframe({
        position: new THREE.Vector3(0, 0, 0),
        rotation: new THREE.Euler(0, 0, 0),
        fov: 75,
      });
      advancedCamera.addKeyframe({
        position: new THREE.Vector3(0, 0, 0),
        rotation: new THREE.Euler(0, Math.PI / 2, 0),
        fov: 60,
      });
      advancedCamera.addKeyframe({
        position: new THREE.Vector3(0, 0, 0),
        rotation: new THREE.Euler(0, Math.PI, 0),
        fov: 75,
      });

      advancedCamera.playPath({
        duration: 15000,
        easing: 'easeInOutQuad',
        loop: true,
      });
    };

    window.stopTour = function () {
      advancedCamera.stopPath();
    };

    window.activateMeasure = function (type) {
      measureTool.activate(type);

      // 更新按钮状态
      document.getElementById('measure-distance-btn').classList.remove('active');
      document.getElementById('measure-angle-btn').classList.remove('active');

      if (type === 'distance') {
        document.getElementById('measure-distance-btn').classList.add('active');
      } else {
        document.getElementById('measure-angle-btn').classList.add('active');
      }
    };

    window.clearMeasurements = function () {
      measureTool.clearAll();
      document.getElementById('measure-distance-btn').classList.remove('active');
      document.getElementById('measure-angle-btn').classList.remove('active');
    };

    window.toggleBloom = function () {
      const current = postProcessing.getOptions();
      postProcessing.setBloomParams({
        strength: current.bloom.enabled ? 0 : 1.5,
      });
    };

    window.toggleVignette = function () {
      // TODO: 实现开关
    };

    window.setExposure = function (value) {
      hdrRenderer.setExposure(parseFloat(value));
      document.getElementById('exposure-value').textContent = value;
    };

    let audioInitialized = false;
    window.toggleAudio = async function () {
      if (!audioInitialized) {
        await spatialAudio.initialize();
        await spatialAudio.addAmbientSound('background.mp3', {
          loop: true,
          volume: 0.5,
          autoplay: true,
        });
        audioInitialized = true;
      } else {
        spatialAudio.pauseAll();
      }
    };

    window.setVolume = function (value) {
      if (spatialAudio) {
        spatialAudio.setMasterVolume(parseFloat(value));
        document.getElementById('volume-value').textContent =
          (parseFloat(value) * 100).toFixed(0) + '%';
      }
    };

    window.enterVR = async function () {
      try {
        await vrManager.initialize();
        await vrManager.enterVR();
      } catch (error) {
        console.error('Failed to enter VR:', error);
        alert('无法进入 VR 模式: ' + error.message);
      }
    };

    window.takeScreenshot = function () {
      const dataUrl = viewer.screenshot();
      const link = document.createElement('a');
      link.download = `panorama_${Date.now()}.png`;
      link.href = dataUrl;
      link.click();
    };

    window.toggleFullscreen = async function () {
      if (viewer.isFullscreen()) {
        viewer.exitFullscreen();
      } else {
        await viewer.enterFullscreen();
      }
    };

    // 清理
    window.addEventListener('beforeunload', () => {
      viewer.dispose();
      memoryManager.dispose();
      postProcessing.dispose();
      spatialAudio.dispose();
      vrManager.dispose();
      measureTool.dispose();
      pluginManager.dispose();
      if (tileManager) tileManager.dispose();
    });

    // 启动应用
    init().catch(error => {
      console.error('Initialization failed:', error);
      alert('初始化失败: ' + error.message);
    });
  </script>
</body>

</html>