<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3D Panorama Viewer - Vanilla JS Demo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 2rem;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .info-banner {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .control-section {
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 8px;
      backdrop-filter: blur(10px);
    }

    .control-section h3 {
      margin: 0 0 10px 0;
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.8);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    button {
      width: 100%;
      padding: 10px 15px;
      margin-bottom: 8px;
      font-size: 13px;
      border: none;
      border-radius: 4px;
      background-color: #42b883;
      color: white;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }

    button:last-child {
      margin-bottom: 0;
    }

    button:hover {
      background-color: #35a372;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    button:active {
      transform: translateY(0);
    }

    .info-text {
      display: block;
      text-align: center;
      color: rgba(255, 255, 255, 0.7);
      font-size: 0.85rem;
      margin-top: 5px;
    }

    #viewer-container {
      width: 100%;
      height: 600px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      margin-bottom: 20px;
    }

    .progress-container {
      margin-bottom: 20px;
      text-align: center;
      display: none;
    }

    .progress-container.active {
      display: block;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 5px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #42b883, #35a372);
      transition: width 0.3s;
      width: 0%;
    }

    .progress-text {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.8);
    }

    .info-panel {
      margin-top: 20px;
      padding: 20px;
      background-color: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      backdrop-filter: blur(10px);
    }

    .info-row {
      margin-bottom: 15px;
    }

    .info-row:last-child {
      margin-bottom: 0;
    }

    .info-row strong {
      display: block;
      margin-bottom: 8px;
      color: #42b883;
    }

    .info-row ul {
      margin: 0;
      padding-left: 20px;
    }

    .info-row li {
      margin-bottom: 5px;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸŒ 3D Panorama Viewer - åŸç”ŸJSæ¼”ç¤º</h1>
    
    <div class="info-banner">
      <strong>âœ¨ çº¯HTML + JavaScriptï¼Œæ— éœ€æ„å»ºå·¥å…·</strong>
      <p style="margin-top: 8px; font-size: 0.9rem; opacity: 0.9;">
        ä½¿ç”¨UMDæ„å»ºï¼Œå¯é€šè¿‡CDNæˆ–æœ¬åœ°æ–‡ä»¶ç›´æ¥å¼•å…¥
      </p>
    </div>

    <div class="controls-grid">
      <div class="control-section">
        <h3>åŸºç¡€æ§åˆ¶</h3>
        <button onclick="toggleAutoRotate()">
          <span id="rotate-btn-text">â–¶ï¸ å¼€å§‹</span> è‡ªåŠ¨æ—‹è½¬
        </button>
        <button onclick="resetView()">ğŸ”„ é‡ç½®è§†è§’</button>
        <button onclick="enableGyro()">ğŸ“± å¯ç”¨é™€èºä»ª</button>
      </div>

      <div class="control-section">
        <h3>é«˜çº§åŠŸèƒ½</h3>
        <button onclick="toggleFullscreen()">
          <span id="fullscreen-btn-text">â›¶ è¿›å…¥</span> å…¨å±
        </button>
        <button onclick="toggleMiniMap()">
          <span id="minimap-btn-text">ğŸ—ºï¸ éšè—</span> å°åœ°å›¾
        </button>
        <button onclick="takeScreenshot()">ğŸ“· æˆªå›¾</button>
      </div>

      <div class="control-section">
        <h3>çƒ­ç‚¹æ ‡è®°</h3>
        <button onclick="addDemoHotspot()">ğŸ“ æ·»åŠ çƒ­ç‚¹</button>
        <button onclick="removeAllHotspots()">ğŸ—‘ï¸ æ¸…ç©ºçƒ­ç‚¹</button>
        <span class="info-text"><span id="hotspot-count">0</span> ä¸ªçƒ­ç‚¹</span>
      </div>

      <div class="control-section">
        <h3>è§†è§’é™åˆ¶</h3>
        <button onclick="setHorizontalLimit()">â†”ï¸ æ°´å¹³é™åˆ¶</button>
        <button onclick="setVerticalLimit()">â†•ï¸ å‚ç›´é™åˆ¶</button>
        <button onclick="clearLimits()">ğŸ”“ æ¸…é™¤é™åˆ¶</button>
      </div>

      <div class="control-section">
        <h3>åˆ‡æ¢å›¾ç‰‡</h3>
        <button onclick="changeImage(0)">ğŸ”ï¸ å±±æ™¯</button>
        <button onclick="changeImage(1)">ğŸŒƒ å¤œæ™¯</button>
      </div>
    </div>

    <div class="progress-container" id="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <span class="progress-text">åŠ è½½ä¸­: <span id="progress-text">0</span>%</span>
    </div>

    <div id="viewer-container"></div>

    <div class="info-panel">
      <div class="info-row">
        <strong>æ§åˆ¶æ–¹å¼:</strong>
        <ul>
          <li><strong>é¼ æ ‡:</strong> æ‹–æ‹½æ—‹è½¬è§†è§’ï¼Œæ»šè½®ç¼©æ”¾</li>
          <li><strong>é”®ç›˜:</strong> æ–¹å‘é”®æ—‹è½¬ï¼Œ+/- é”®ç¼©æ”¾</li>
          <li><strong>è§¦å±:</strong> å•æŒ‡æ‹–æ‹½æ—‹è½¬ï¼ŒåŒæŒ‡ç¼©æ”¾</li>
          <li><strong>ç§»åŠ¨ç«¯:</strong> è®¾å¤‡æ–¹å‘æ„Ÿåº”ï¼ˆéœ€æˆæƒï¼‰</li>
        </ul>
      </div>
      
      <div class="info-row">
        <strong>æœ€åç‚¹å‡»çš„çƒ­ç‚¹:</strong>
        <div id="last-hotspot" style="font-size: 0.9rem; opacity: 0.8;">æš‚æ— </div>
      </div>

      <div class="info-row">
        <strong>ç‰¹æ€§ (v2.1):</strong>
        <ul>
          <li>âœ… é”®ç›˜æ§åˆ¶</li>
          <li>âœ… å°åœ°å›¾ä¸æŒ‡å—é’ˆ</li>
          <li>âœ… äº¤äº’å¼çƒ­ç‚¹æ ‡è®°</li>
          <li>âœ… å…¨å±æ¨¡å¼</li>
          <li>âœ… æˆªå›¾åŠŸèƒ½</li>
          <li>âœ… è§†è§’é™åˆ¶</li>
          <li>âœ… å¹³æ»‘è¿‡æ¸¡æ•ˆæœ</li>
          <li>âœ… åŠ è½½è¿›åº¦æ˜¾ç¤º</li>
          <li>âœ… æ€§èƒ½ä¼˜åŒ–</li>
          <li>ğŸ†• æ™ºèƒ½è®¾å¤‡é€‚é…</li>
          <li>ğŸ†• æ ¼å¼è‡ªåŠ¨æ£€æµ‹ (WebP/AVIF)</li>
          <li>ğŸ†• ç”µæºç®¡ç†</li>
          <li>ğŸ†• CDNå®¹é”™</li>
        </ul>
      </div>

      <div class="info-row">
        <strong>è®¾å¤‡ä¿¡æ¯:</strong>
        <div id="device-info" style="font-size: 0.85rem; white-space: pre-line; opacity: 0.8; max-height: 200px; overflow-y: auto;">
          æ­£åœ¨æ£€æµ‹...
        </div>
      </div>

      <div class="info-row">
        <strong>æ€§èƒ½:</strong>
        <div style="font-size: 0.85rem;">
          <div>ç”µæºæ¨¡å¼: <span id="power-mode">æ£€æµ‹ä¸­...</span></div>
          <div>æ”¯æŒæ ¼å¼: <span id="supported-formats">æ£€æµ‹ä¸­...</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Three.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  
  <!-- Panorama Viewer (use local build or CDN) -->
  <!-- For development: use local build -->
  <script src="../../packages/core/dist/panorama-viewer.js"></script>
  
  <!-- For production: uncomment this line and comment out the local build -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/@panorama-viewer/core@2.0.0/dist/panorama-viewer.min.js"></script> -->

  <script>
    // Global state
    let viewer = null;
    let autoRotate = false;
    let showMiniMap = true;
    let isFullscreen = false;
    let hotspotCounter = 0;
    let hotspots = [];

    const images = [
      'https://threejs.org/examples/textures/2294472375_24a3b8ef46_o.jpg',
      'https://threejs.org/examples/textures/2294472375_24a3b8ef46_o.jpg',
    ];

    let currentImageIndex = 0;

    // Initialize viewer on page load
    window.addEventListener('DOMContentLoaded', () => {
      initViewer();
      initDeviceInfo();
    });

    function initViewer() {
      const container = document.getElementById('viewer-container');
      
      // Get device capability and recommended settings
      const { deviceCapability } = PanoramaViewer;
      const settings = deviceCapability ? deviceCapability.getRecommendedSettings() : {};
      
      viewer = new PanoramaViewer.PanoramaViewer({
        container: container,
        image: images[currentImageIndex],
        fov: 75,
        autoRotate: false,
        gyroscope: true,
        onProgress: (progress) => {
          updateProgress(progress);
        },
        ...settings,
      });

      console.log('âœ… Viewer initialized!');
      console.log('ğŸ“¦ Available exports:', Object.keys(PanoramaViewer));
    }

    function initDeviceInfo() {
      // Get device capability info
      if (PanoramaViewer.deviceCapability) {
        const report = PanoramaViewer.deviceCapability.generateReport();
        document.getElementById('device-info').textContent = report;
      }

      // Get supported formats
      if (PanoramaViewer.formatDetector) {
        const support = PanoramaViewer.formatDetector.getSupport();
        document.getElementById('supported-formats').textContent = 
          `WebP: ${support.webp ? 'âœ…' : 'âŒ'}, AVIF: ${support.avif ? 'âœ…' : 'âŒ'}`;
      }

      // Start power monitoring
      if (PanoramaViewer.powerManager) {
        PanoramaViewer.powerManager.startMonitoring();
        PanoramaViewer.powerManager.onChange((mode) => {
          document.getElementById('power-mode').textContent = 
            `${mode.mode} (ç›®æ ‡${mode.targetFPS}fps)`;
        });
      }
    }

    function updateProgress(progress) {
      const container = document.getElementById('progress-container');
      const fill = document.getElementById('progress-fill');
      const text = document.getElementById('progress-text');
      
      if (progress > 0 && progress < 100) {
        container.classList.add('active');
        fill.style.width = progress + '%';
        text.textContent = Math.round(progress);
      } else {
        setTimeout(() => {
          container.classList.remove('active');
        }, 500);
      }
    }

    function toggleAutoRotate() {
      autoRotate = !autoRotate;
      const btnText = document.getElementById('rotate-btn-text');
      
      if (autoRotate) {
        viewer.enableAutoRotate();
        btnText.textContent = 'â¸ï¸ åœæ­¢';
      } else {
        viewer.disableAutoRotate();
        btnText.textContent = 'â–¶ï¸ å¼€å§‹';
      }
    }

    function resetView() {
      viewer.reset();
    }

    async function enableGyro() {
      const success = await viewer.enableGyroscope();
      if (success) {
        alert('âœ… é™€èºä»ªå·²å¯ç”¨ï¼');
      } else {
        alert('âŒ é™€èºä»ªä¸å¯ç”¨æˆ–æƒé™è¢«æ‹’ç»');
      }
    }

    async function toggleFullscreen() {
      const btnText = document.getElementById('fullscreen-btn-text');
      
      if (isFullscreen) {
        viewer.exitFullscreen();
        isFullscreen = false;
        btnText.textContent = 'â›¶ è¿›å…¥';
      } else {
        await viewer.enterFullscreen();
        isFullscreen = true;
        btnText.textContent = 'â¬œ é€€å‡º';
      }
    }

    function toggleMiniMap() {
      showMiniMap = !showMiniMap;
      const btnText = document.getElementById('minimap-btn-text');
      
      if (showMiniMap) {
        viewer.showMiniMap();
        btnText.textContent = 'ğŸ—ºï¸ éšè—';
      } else {
        viewer.hideMiniMap();
        btnText.textContent = 'ğŸ—ºï¸ æ˜¾ç¤º';
      }
    }

    function takeScreenshot() {
      const dataURL = viewer.screenshot(1920, 1080);
      if (dataURL) {
        const link = document.createElement('a');
        link.download = 'panorama-screenshot.png';
        link.href = dataURL;
        link.click();
        alert('ğŸ“¸ æˆªå›¾å·²ä¿å­˜å¹¶ä¸‹è½½ï¼');
      }
    }

    function addDemoHotspot() {
      hotspotCounter++;
      const newHotspot = {
        id: `hotspot-${hotspotCounter}`,
        position: {
          theta: Math.random() * Math.PI * 2,
          phi: Math.PI / 2 + (Math.random() - 0.5) * Math.PI * 0.5,
        },
        label: `ğŸ“ #${hotspotCounter}`,
        data: { name: `å…´è¶£ç‚¹ ${hotspotCounter}` },
      };
      
      viewer.addHotspot(newHotspot);
      hotspots = viewer.getHotspots();
      document.getElementById('hotspot-count').textContent = hotspots.length;
      
      // Note: In vanilla JS, hotspot click events would need to be handled through custom events
    }

    function removeAllHotspots() {
      hotspots.forEach(h => viewer.removeHotspot(h.id));
      hotspots = [];
      hotspotCounter = 0;
      document.getElementById('hotspot-count').textContent = '0';
    }

    function setHorizontalLimit() {
      viewer.setViewLimits({
        minTheta: -Math.PI / 4,
        maxTheta: Math.PI / 4,
      });
      alert('â†”ï¸ æ°´å¹³æ—‹è½¬å·²é™åˆ¶åœ¨ Â±45Â°');
    }

    function setVerticalLimit() {
      viewer.setViewLimits({
        minPhi: Math.PI / 3,
        maxPhi: (2 * Math.PI) / 3,
      });
      alert('â†•ï¸ å‚ç›´æ—‹è½¬å·²é™åˆ¶');
    }

    function clearLimits() {
      viewer.setViewLimits(null);
      alert('ğŸ”“ æ‰€æœ‰æ—‹è½¬é™åˆ¶å·²æ¸…é™¤');
    }

    async function changeImage(index) {
      currentImageIndex = index;
      updateProgress(0);
      await viewer.loadImage(images[index], true);
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (viewer) {
        viewer.dispose();
      }
      if (PanoramaViewer.powerManager) {
        PanoramaViewer.powerManager.stopMonitoring();
      }
    });
  </script>
</body>
</html>

