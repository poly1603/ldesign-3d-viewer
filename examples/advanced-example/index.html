<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>3D Panorama Viewer - é«˜çº§ç¤ºä¾‹</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      overflow: hidden;
    }

    #viewer {
      width: 100vw;
      height: 100vh;
    }

    .controls-panel {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 20px;
      border-radius: 8px;
      min-width: 250px;
      max-height: 80vh;
      overflow-y: auto;
      z-index: 1000;
    }

    .controls-panel h3 {
      margin: 0 0 15px 0;
      font-size: 18px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 10px;
    }

    .control-group {
      margin-bottom: 20px;
    }

    .control-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 12px;
      color: #aaa;
    }

    .control-group button {
      width: 100%;
      padding: 10px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }

    .control-group button:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .control-group button.active {
      background: rgba(76, 175, 80, 0.5);
      border-color: #4CAF50;
    }

    .control-group input[type="range"] {
      width: 100%;
      margin-top: 5px;
    }

    .stats-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      color: #0f0;
      padding: 15px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      z-index: 1000;
      min-width: 200px;
    }

    .stats-panel .stat-row {
      margin-bottom: 5px;
    }

    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .loading-overlay.hidden {
      display: none;
    }

    .progress-bar {
      width: 300px;
      height: 6px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 20px;
    }

    .progress-bar-fill {
      height: 100%;
      background: #4CAF50;
      transition: width 0.3s;
      width: 0%;
    }

    .loading-text {
      color: white;
      font-size: 18px;
    }
  </style>
</head>

<body>
  <div id="viewer"></div>

  <!-- åŠ è½½ç•Œé¢ -->
  <div id="loading" class="loading-overlay">
    <div class="loading-text">åŠ è½½ä¸­...</div>
    <div class="progress-bar">
      <div id="progress-fill" class="progress-bar-fill"></div>
    </div>
    <div id="progress-text" style="color: white; margin-top: 10px;">0%</div>
  </div>

  <!-- æ§åˆ¶é¢æ¿ -->
  <div class="controls-panel">
    <h3>ğŸ® æ§åˆ¶é¢æ¿</h3>

    <div class="control-group">
      <label>åœºæ™¯åˆ‡æ¢</label>
      <button onclick="loadScene('living-room')">å®¢å…</button>
      <button onclick="loadScene('kitchen')">å¨æˆ¿</button>
      <button onclick="loadScene('bedroom')">å§å®¤</button>
    </div>

    <div class="control-group">
      <label>ç›¸æœºæ§åˆ¶</label>
      <button onclick="resetCamera()">é‡ç½®è§†è§’</button>
      <button onclick="toggleAutoRotate()">è‡ªåŠ¨æ—‹è½¬</button>
      <button onclick="startTour()">è‡ªåŠ¨å¯¼è§ˆ</button>
      <button onclick="stopTour()">åœæ­¢å¯¼è§ˆ</button>
    </div>

    <div class="control-group">
      <label>æµ‹é‡å·¥å…·</label>
      <button id="measure-distance-btn" onclick="activateMeasure('distance')">æµ‹è·</button>
      <button id="measure-angle-btn" onclick="activateMeasure('angle')">æµ‹è§’</button>
      <button onclick="clearMeasurements()">æ¸…é™¤æµ‹é‡</button>
    </div>

    <div class="control-group">
      <label>åå¤„ç†æ•ˆæœ</label>
      <button onclick="toggleBloom()">Bloom å…‰æ™•</button>
      <button onclick="toggleVignette()">æ™•å½±æ•ˆæœ</button>
      <label>æ›å…‰: <span id="exposure-value">1.0</span></label>
      <input type="range" min="0" max="3" step="0.1" value="1.0" oninput="setExposure(this.value)">
    </div>

    <div class="control-group">
      <label>éŸ³é¢‘</label>
      <button onclick="toggleAudio()">å¼€å¯/å…³é—­éŸ³é¢‘</button>
      <label>éŸ³é‡: <span id="volume-value">80%</span></label>
      <input type="range" min="0" max="1" step="0.1" value="0.8" oninput="setVolume(this.value)">
    </div>

    <div class="control-group">
      <label>VR/æˆªå›¾</label>
      <button id="vr-btn" onclick="enterVR()">è¿›å…¥ VR</button>
      <button onclick="takeScreenshot()">æˆªå›¾</button>
      <button onclick="toggleFullscreen()">å…¨å±</button>
    </div>
  </div>

  <!-- ç»Ÿè®¡é¢æ¿ -->
  <div class="stats-panel">
    <div class="stat-row">FPS: <span id="fps">--</span></div>
    <div class="stat-row">å¸§æ—¶é—´: <span id="frametime">--</span>ms</div>
    <div class="stat-row">å†…å­˜: <span id="memory">--</span>MB</div>
    <div class="stat-row">çº¹ç†: <span id="textures">--</span></div>
    <div class="stat-row">ç“¦ç‰‡: <span id="tiles">--</span></div>
  </div>

  <script type="module">
    import {
      PanoramaViewer,
      EventBus,
      MemoryManager,
      PostProcessing,
      AdvancedCamera,
      SpatialAudio,
      VRManager,
      MeasureTool,
      TileManager,
      PluginManager,
      SharePlugin,
      HDRRenderer,
      logger,
      LogLevel,
      isMobile,
    } from '@panorama-viewer/core';

    // è®¾ç½®æ—¥å¿—
    logger.setLevel(LogLevel.INFO);

    // åˆ›å»ºäº‹ä»¶æ€»çº¿
    const eventBus = new EventBus();

    // å…¨å±€å˜é‡
    let viewer, memoryManager, postProcessing, advancedCamera;
    let spatialAudio, vrManager, measureTool, tileManager;
    let hdrRenderer, pluginManager;

    // åˆå§‹åŒ–
    async function init() {
      const container = document.getElementById('viewer');

      // åˆ›å»º viewer
      viewer = new PanoramaViewer({
        container,
        image: 'panorama.jpg',
        autoRotate: true,
        autoRotateSpeed: 0.3,
        renderOnDemand: true,
        enablePerformanceMonitor: true,
        enableAdaptiveQuality: true,
        maxTextureSize: isMobile() ? 2048 : 4096,
      }, eventBus);

      // å†…å­˜ç®¡ç†
      memoryManager = new MemoryManager({
        maxTextureMemory: 512 * 1024 * 1024,
        autoCleanup: true,
      }, eventBus);
      memoryManager.startMonitoring(5000);

      // åå¤„ç†
      postProcessing = new PostProcessing(
        viewer.renderer,
        viewer.scene,
        viewer.camera,
        {
          antialiasing: 'smaa',
          bloom: { enabled: true, strength: 1.5 },
          vignette: { enabled: true },
        }
      );
      postProcessing.initialize();

      // HDR æ¸²æŸ“å™¨
      hdrRenderer = new HDRRenderer(viewer.renderer, viewer.scene, {
        toneMapping: 'aces',
        exposure: 1.0,
      });

      // é«˜çº§ç›¸æœº
      advancedCamera = new AdvancedCamera(viewer.camera);

      // ç©ºé—´éŸ³é¢‘
      spatialAudio = new SpatialAudio(viewer.camera);

      // VR ç®¡ç†å™¨
      vrManager = new VRManager(
        viewer.renderer,
        viewer.camera,
        viewer.scene,
        { controllers: true },
        eventBus
      );

      // æ£€æŸ¥ VR æ”¯æŒ
      const vrSupported = await VRManager.isVRSupported();
      if (!vrSupported) {
        document.getElementById('vr-btn').disabled = true;
        document.getElementById('vr-btn').textContent = 'VR ä¸æ”¯æŒ';
      }

      // æµ‹é‡å·¥å…·
      measureTool = new MeasureTool(
        viewer.scene,
        viewer.camera,
        container,
        eventBus
      );

      // æ’ä»¶ç®¡ç†å™¨
      pluginManager = new PluginManager(eventBus);
      pluginManager.setContext({
        viewer,
        eventBus,
        scene: viewer.scene,
        camera: viewer.camera,
        renderer: viewer.renderer,
        container,
      });
      await pluginManager.install(SharePlugin);

      // ç›‘å¬äº‹ä»¶
      setupEventListeners();

      // éšè—åŠ è½½ç•Œé¢
      document.getElementById('loading').classList.add('hidden');

      // å¼€å§‹åŠ¨ç”»å¾ªç¯
      animate();
    }

    // äº‹ä»¶ç›‘å¬
    function setupEventListeners() {
      eventBus.on('image:loading', ({ progress }) => {
        updateProgress(progress);
      });

      eventBus.on('viewer:ready', () => {
        console.log('Viewer ready!');
      });

      eventBus.on('performance:warning', ({ type, message }) => {
        console.warn('Performance warning:', message);
      });

      eventBus.on('hotspot:click', ({ id }) => {
        console.log('Hotspot clicked:', id);
      });
    }

    // æ›´æ–°è¿›åº¦
    function updateProgress(progress) {
      const fill = document.getElementById('progress-fill');
      const text = document.getElementById('progress-text');
      fill.style.width = progress + '%';
      text.textContent = progress.toFixed(1) + '%';
    }

    // åŠ¨ç”»å¾ªç¯
    function animate() {
      advancedCamera.update();
      if (spatialAudio) spatialAudio.update();
      if (measureTool) measureTool.update();
      if (tileManager) tileManager.update();
      if (pluginManager) pluginManager.update(16);

      postProcessing.render();

      // æ›´æ–°ç»Ÿè®¡
      updateStats();

      requestAnimationFrame(animate);
    }

    // æ›´æ–°ç»Ÿè®¡é¢æ¿
    function updateStats() {
      const stats = viewer.getPerformanceStats();
      if (stats) {
        document.getElementById('fps').textContent = stats.fps;
        document.getElementById('frametime').textContent = stats.frameTime.toFixed(2);
      }

      const memStats = memoryManager.getStats();
      const memMB = (memStats.total / 1024 / 1024).toFixed(1);
      document.getElementById('memory').textContent = memMB;
      document.getElementById('textures').textContent = memStats.textures.count;

      if (tileManager) {
        const tileStats = tileManager.getStats();
        document.getElementById('tiles').textContent =
          `${tileStats.visibleTiles}/${tileStats.loadedTiles}`;
      }
    }

    // å…¨å±€å‡½æ•°
    window.loadScene = async function (scene) {
      const sceneUrls = {
        'living-room': 'living-room.jpg',
        'kitchen': 'kitchen.jpg',
        'bedroom': 'bedroom.jpg',
      };

      await viewer.loadImage(sceneUrls[scene], true);
    };

    window.resetCamera = function () {
      viewer.reset();
    };

    window.toggleAutoRotate = function () {
      if (viewer.isAutoRotating()) {
        viewer.disableAutoRotate();
      } else {
        viewer.enableAutoRotate();
      }
    };

    window.startTour = function () {
      // æ·»åŠ å…³é”®å¸§
      advancedCamera.clearKeyframes();
      advancedCamera.addKeyframe({
        position: new THREE.Vector3(0, 0, 0),
        rotation: new THREE.Euler(0, 0, 0),
        fov: 75,
      });
      advancedCamera.addKeyframe({
        position: new THREE.Vector3(0, 0, 0),
        rotation: new THREE.Euler(0, Math.PI / 2, 0),
        fov: 60,
      });
      advancedCamera.addKeyframe({
        position: new THREE.Vector3(0, 0, 0),
        rotation: new THREE.Euler(0, Math.PI, 0),
        fov: 75,
      });

      advancedCamera.playPath({
        duration: 15000,
        easing: 'easeInOutQuad',
        loop: true,
      });
    };

    window.stopTour = function () {
      advancedCamera.stopPath();
    };

    window.activateMeasure = function (type) {
      measureTool.activate(type);

      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.getElementById('measure-distance-btn').classList.remove('active');
      document.getElementById('measure-angle-btn').classList.remove('active');

      if (type === 'distance') {
        document.getElementById('measure-distance-btn').classList.add('active');
      } else {
        document.getElementById('measure-angle-btn').classList.add('active');
      }
    };

    window.clearMeasurements = function () {
      measureTool.clearAll();
      document.getElementById('measure-distance-btn').classList.remove('active');
      document.getElementById('measure-angle-btn').classList.remove('active');
    };

    window.toggleBloom = function () {
      const current = postProcessing.getOptions();
      postProcessing.setBloomParams({
        strength: current.bloom.enabled ? 0 : 1.5,
      });
    };

    window.toggleVignette = function () {
      // TODO: å®ç°å¼€å…³
    };

    window.setExposure = function (value) {
      hdrRenderer.setExposure(parseFloat(value));
      document.getElementById('exposure-value').textContent = value;
    };

    let audioInitialized = false;
    window.toggleAudio = async function () {
      if (!audioInitialized) {
        await spatialAudio.initialize();
        await spatialAudio.addAmbientSound('background.mp3', {
          loop: true,
          volume: 0.5,
          autoplay: true,
        });
        audioInitialized = true;
      } else {
        spatialAudio.pauseAll();
      }
    };

    window.setVolume = function (value) {
      if (spatialAudio) {
        spatialAudio.setMasterVolume(parseFloat(value));
        document.getElementById('volume-value').textContent =
          (parseFloat(value) * 100).toFixed(0) + '%';
      }
    };

    window.enterVR = async function () {
      try {
        await vrManager.initialize();
        await vrManager.enterVR();
      } catch (error) {
        console.error('Failed to enter VR:', error);
        alert('æ— æ³•è¿›å…¥ VR æ¨¡å¼: ' + error.message);
      }
    };

    window.takeScreenshot = function () {
      const dataUrl = viewer.screenshot();
      const link = document.createElement('a');
      link.download = `panorama_${Date.now()}.png`;
      link.href = dataUrl;
      link.click();
    };

    window.toggleFullscreen = async function () {
      if (viewer.isFullscreen()) {
        viewer.exitFullscreen();
      } else {
        await viewer.enterFullscreen();
      }
    };

    // æ¸…ç†
    window.addEventListener('beforeunload', () => {
      viewer.dispose();
      memoryManager.dispose();
      postProcessing.dispose();
      spatialAudio.dispose();
      vrManager.dispose();
      measureTool.dispose();
      pluginManager.dispose();
      if (tileManager) tileManager.dispose();
    });

    // å¯åŠ¨åº”ç”¨
    init().catch(error => {
      console.error('Initialization failed:', error);
      alert('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
    });
  </script>
</body>

</html>